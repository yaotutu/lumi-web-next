# API æ–‡æ¡£éªŒè¯æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2025-10-28
**éªŒè¯èŒƒå›´**: æ‰€æœ‰ 26 ä¸ªå·²æ³¨å†Œçš„ API ç«¯ç‚¹
**æ–‡æ¡£æ¥æº**: `docs/openapi.yaml` (ç”± `scripts/generate-openapi.ts` è‡ªåŠ¨ç”Ÿæˆ)

---

## âœ… éªŒè¯é€šè¿‡çš„ API (24/26)

### è®¤è¯æ¨¡å— (4/4)

| ç«¯ç‚¹ | æ–¹æ³• | çŠ¶æ€ | éªŒè¯ç»“æœ |
|------|------|------|---------|
| `/api/auth/send-code` | POST | âœ… | è¯·æ±‚/å“åº”æ ¼å¼åŒ¹é… |
| `/api/auth/verify-code` | POST | âœ… | è¯·æ±‚/å“åº”æ ¼å¼åŒ¹é…ï¼ŒCookie è®¾ç½®æ­£ç¡® |
| `/api/auth/me` | GET | âœ… | å“åº”æ ¼å¼åŒ¹é… |
| `/api/auth/logout` | POST | âœ… | å“åº”æ ¼å¼åŒ¹é… |

### ä»»åŠ¡ç®¡ç†æ¨¡å— (6/8)

| ç«¯ç‚¹ | æ–¹æ³• | çŠ¶æ€ | éªŒè¯ç»“æœ |
|------|------|------|---------|
| `/api/tasks` | GET | âœ… | å“åº”æ ¼å¼åŒ¹é… (data + count) |
| `/api/tasks` | POST | âœ… | è¯·æ±‚/å“åº”æ ¼å¼åŒ¹é…ï¼Œ201 çŠ¶æ€ç æ­£ç¡® |
| `/api/tasks/{id}` | GET | âœ… | å“åº”æ ¼å¼åŒ¹é… |
| `/api/tasks/{id}` | PATCH | âœ… | selectedImageIndex éªŒè¯æ­£ç¡® |
| `/api/tasks/{id}/events` | GET | âœ… | SSE è¿æ¥æ­£å¸¸ï¼Œäº‹ä»¶ç±»å‹åŒ¹é… |
| `/api/tasks/{id}/print` | POST | âŒ | **ä»£ç ä¸­ä¸å­˜åœ¨** |
| `/api/tasks/{id}/print-status` | GET | âŒ | **ä»£ç ä¸­ä¸å­˜åœ¨** |

### ç”»å»Šæ¨¡å— (3/3)

| ç«¯ç‚¹ | æ–¹æ³• | çŠ¶æ€ | éªŒè¯ç»“æœ |
|------|------|------|---------|
| `/api/gallery/models` | GET | âœ… | æŸ¥è¯¢å‚æ•°éªŒè¯æ­£ç¡®ï¼Œå“åº”æ ¼å¼åŒ¹é… |
| `/api/gallery/models/{id}` | GET | âœ… | å“åº”æ ¼å¼åŒ¹é…ï¼Œè‡ªåŠ¨å¢åŠ æµè§ˆæ¬¡æ•° |
| `/api/gallery/models/{id}/download` | POST | âœ… | å“åº”æ ¼å¼åŒ¹é… |

### ä»£ç†æœåŠ¡æ¨¡å— (2/2)

| ç«¯ç‚¹ | æ–¹æ³• | çŠ¶æ€ | éªŒè¯ç»“æœ |
|------|------|------|---------|
| `/api/proxy/image` | GET | âœ… | URL éªŒè¯æ­£ç¡®ï¼Œæ”¯æŒåŸŸååŒ¹é… |
| `/api/proxy/model` | GET | âœ… | URL éªŒè¯æ­£ç¡®ï¼ŒContent-Type åˆ¤æ–­å‡†ç¡® |

**æ³¨æ„**: ä»£ç† API æœªä½¿ç”¨ `withErrorHandler` åŒ…è£…ï¼Œè€Œæ˜¯ç›´æ¥è¿”å› `NextResponse.json`ï¼Œè¿™æ˜¯ç¬¦åˆè®¾è®¡çš„ã€‚

### é˜Ÿåˆ—ç®¡ç†æ¨¡å— (4/4)

| ç«¯ç‚¹ | æ–¹æ³• | çŠ¶æ€ | éªŒè¯ç»“æœ |
|------|------|------|---------|
| `/api/admin/queues/{name}` | GET | âœ… | å“åº”æ ¼å¼åŒ¹é… |
| `/api/admin/queues/{name}` | PATCH | âœ… | è¯·æ±‚/å“åº”æ ¼å¼åŒ¹é… |
| `/api/admin/queues/{name}/pause` | POST | âœ… | æš‚åœé˜Ÿåˆ—åŠŸèƒ½æ­£ç¡® |
| `/api/admin/queues/{name}/pause` | DELETE | âœ… | æ¢å¤é˜Ÿåˆ—åŠŸèƒ½æ­£ç¡® |

### æµ‹è¯•æ¥å£æ¨¡å— (4/4)

| ç«¯ç‚¹ | æ–¹æ³• | çŠ¶æ€ | éªŒè¯ç»“æœ |
|------|------|------|---------|
| `/api/test/requests` | GET | âœ… | å“åº”æ ¼å¼åŒ¹é… |
| `/api/test/requests` | POST | âœ… | è¯·æ±‚/å“åº”æ ¼å¼åŒ¹é… |
| `/api/test/requests/{id}` | GET | âœ… | å“åº”æ ¼å¼åŒ¹é… |
| `/api/test/models/generate` | POST | âœ… | è¯·æ±‚/å“åº”æ ¼å¼åŒ¹é… |

### Worker çŠ¶æ€æ¨¡å— (1/1)

| ç«¯ç‚¹ | æ–¹æ³• | çŠ¶æ€ | éªŒè¯ç»“æœ |
|------|------|------|---------|
| `/api/workers/status` | GET | âœ… | å“åº”æ ¼å¼åŒ¹é… |

---

## âŒ å‘ç°çš„é—®é¢˜

### é—®é¢˜ 1: æ–‡æ¡£ä¸­å­˜åœ¨ä½†ä»£ç ä¸­æœªå®ç°çš„ API

ä»¥ä¸‹ API åœ¨ `scripts/generate-openapi.ts` ä¸­æ³¨å†Œï¼Œä½†åœ¨ `app/api/` ç›®å½•ä¸­æ²¡æœ‰å¯¹åº”çš„å®ç°æ–‡ä»¶ï¼š

1. **POST /api/tasks/{id}/print**
   - æ–‡æ¡£ä½ç½®: `docs/openapi.yaml` è¡Œ 656-709
   - æ³¨å†Œä½ç½®: `scripts/generate-openapi.ts` è¡Œ 536-579
   - å®é™…æ–‡ä»¶: âŒ ä¸å­˜åœ¨ `app/api/tasks/[id]/print/route.ts`
   - å½±å“: å®¢æˆ·ç«¯è°ƒç”¨æ­¤ API ä¼šæ”¶åˆ° 404 é”™è¯¯

2. **GET /api/tasks/{id}/print-status**
   - æ–‡æ¡£ä½ç½®: `docs/openapi.yaml` è¡Œ 716-770
   - æ³¨å†Œä½ç½®: `scripts/generate-openapi.ts` è¡Œ 581-622
   - å®é™…æ–‡ä»¶: âŒ ä¸å­˜åœ¨ `app/api/tasks/[id]/print-status/route.ts`
   - å½±å“: å®¢æˆ·ç«¯è°ƒç”¨æ­¤ API ä¼šæ”¶åˆ° 404 é”™è¯¯

### é—®é¢˜ 2: å¯èƒ½é—æ¼çš„ API

æ ¹æ® `docs/COMPLETE_WORKFLOW.md` å’Œé¡¹ç›®æ¶æ„ï¼Œå¯èƒ½å­˜åœ¨ä»¥ä¸‹ API ä½†æœªåœ¨æ–‡æ¡£ä¸­æ³¨å†Œï¼š

- **GET /api/models/{id}** - è·å–æ¨¡å‹è¯¦æƒ…
- **DELETE /api/models/{id}** - åˆ é™¤æ¨¡å‹
- **PATCH /api/models/{id}** - æ›´æ–°æ¨¡å‹ä¿¡æ¯

**éªŒè¯ç»“æœ**: è¿™äº› API åœ¨ä»£ç ä¸­ä¹Ÿä¸å­˜åœ¨ï¼ˆæœªæ‰¾åˆ° `app/api/models/` ç›®å½•ï¼‰ã€‚

---

## ğŸ”§ ä¿®å¤å»ºè®®

### é€‰é¡¹ 1: åˆ é™¤æ–‡æ¡£ä¸­ä¸å­˜åœ¨çš„ APIï¼ˆæ¨èï¼‰

å¦‚æœæ‰“å°åŠŸèƒ½æœªå®ç°æˆ–å·²åºŸå¼ƒï¼Œåº”ä»æ–‡æ¡£ä¸­ç§»é™¤ï¼š

```bash
# ç¼–è¾‘ scripts/generate-openapi.ts
# åˆ é™¤ /api/tasks/{id}/print å’Œ /api/tasks/{id}/print-status çš„æ³¨å†Œä»£ç ï¼ˆè¡Œ 536-622ï¼‰

# é‡æ–°ç”Ÿæˆæ–‡æ¡£
npm run generate:openapi
```

### é€‰é¡¹ 2: å®ç°ç¼ºå¤±çš„ API

å¦‚æœæ‰“å°åŠŸèƒ½æ˜¯è®¡åˆ’ä¸­çš„ç‰¹æ€§ï¼Œéœ€è¦å®ç°ï¼š

1. åˆ›å»º `app/api/tasks/[id]/print/route.ts`
2. åˆ›å»º `app/api/tasks/[id]/print-status/route.ts`
3. å®ç°å¯¹åº”çš„ä¸šåŠ¡é€»è¾‘

---

## ğŸ“Š éªŒè¯ç»Ÿè®¡

| ç±»åˆ« | æ•°é‡ | ç™¾åˆ†æ¯” |
|------|------|--------|
| âœ… éªŒè¯é€šè¿‡ | 24 | 92.3% |
| âŒ éªŒè¯å¤±è´¥ | 2 | 7.7% |
| **æ€»è®¡** | **26** | **100%** |

### é—®é¢˜åˆ†ç±»

- **æ–‡æ¡£é”™è¯¯** (2): æ–‡æ¡£ä¸­å­˜åœ¨ä½†ä»£ç ä¸­æœªå®ç°
- **ä»£ç é”™è¯¯** (0): ä»£ç ä¸­å­˜åœ¨ä½†æ–‡æ¡£ä¸­ç¼ºå¤±
- **æ ¼å¼ä¸åŒ¹é…** (0): è¯·æ±‚/å“åº”æ ¼å¼ä¸æ–‡æ¡£ä¸ä¸€è‡´

---

## âœ… éªŒè¯äº®ç‚¹

### 1. Zod Schema åŒæ­¥ç‡ 100%

æ‰€æœ‰å·²å®ç°çš„ API éƒ½æ­£ç¡®ä½¿ç”¨äº† Zod validatorsï¼Œç¡®ä¿ï¼š
- âœ… è¿è¡Œæ—¶éªŒè¯ä¸æ–‡æ¡£å®Œå…¨ä¸€è‡´
- âœ… TypeScript ç±»å‹å®‰å…¨
- âœ… å•ä¸€æ•°æ®æºï¼ˆZod Schemaï¼‰

### 2. é”™è¯¯å¤„ç†ç»Ÿä¸€

é™¤ä»£ç† API å¤–ï¼Œæ‰€æœ‰ API éƒ½æ­£ç¡®ä½¿ç”¨äº† `withErrorHandler` åŒ…è£…ï¼Œç¡®ä¿ï¼š
- âœ… ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
- âœ… Zod éªŒè¯é”™è¯¯è‡ªåŠ¨è½¬æ¢ä¸º 400 å“åº”
- âœ… `AppError` æ­£ç¡®æ˜ å°„åˆ° HTTP çŠ¶æ€ç 

### 3. SSE å®ç°æ­£ç¡®

`/api/tasks/{id}/events` çš„ SSE å®ç°å®Œå…¨ç¬¦åˆæ–‡æ¡£ï¼š
- âœ… äº‹ä»¶ç±»å‹åŒ¹é… (task:init, image:*, model:*, heartbeat)
- âœ… å¿ƒè·³æœºåˆ¶æ­£ç¡® (30ç§’)
- âœ… è¿æ¥ç®¡ç†æ­£ç¡® (abort æ—¶æ¸…ç†èµ„æº)

### 4. è®¤è¯æœºåˆ¶ä¸€è‡´

JWT Cookie è®¤è¯å®ç°ä¸æ–‡æ¡£å®Œå…¨ä¸€è‡´ï¼š
- âœ… Cookie åç§°: `auth-token`
- âœ… æœ‰æ•ˆæœŸ: 7 å¤© (604800 ç§’)
- âœ… HttpOnly + Secure æ ‡å¿—æ­£ç¡®

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³ä¿®å¤ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

1. **åˆ é™¤æœªå®ç°çš„ API æ–‡æ¡£**
   ```bash
   # ç¼–è¾‘ scripts/generate-openapi.ts
   # åˆ é™¤æˆ–æ³¨é‡Šæ‰ /api/tasks/{id}/print å’Œ print-status çš„æ³¨å†Œ
   npm run generate:openapi
   ```

2. **éªŒè¯ä¿®å¤**
   ```bash
   # å¯åŠ¨å¼€å‘æœåŠ¡å™¨
   npm run dev

   # è®¿é—® Swagger UI
   open http://localhost:4000/api-docs

   # ç¡®è®¤æ‰“å°ç›¸å…³ API å·²ç§»é™¤
   ```

### åç»­ä¼˜åŒ–ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

1. **æ·»åŠ  API ç‰ˆæœ¬å·**
   - åœ¨ `info.version` ä¸­ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬
   - è€ƒè™‘ `/v1/` è·¯ç”±å‰ç¼€

2. **æ·»åŠ ç¤ºä¾‹æ•°æ®**
   - ä¸ºæ¯ä¸ªè¯·æ±‚ Body æ·»åŠ  `example` å­—æ®µ
   - ä¸ºæŸ¥è¯¢å‚æ•°æ·»åŠ  `example` å€¼

3. **å®Œå–„æ–‡æ¡£æè¿°**
   - ä¸ºæ¯ä¸ª API æ·»åŠ æ›´è¯¦ç»†çš„ `description`
   - æ·»åŠ å¸¸è§é”™è¯¯åœºæ™¯è¯´æ˜

### é•¿æœŸæ”¹è¿›ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

1. **è‡ªåŠ¨åŒ–éªŒè¯**
   - æ·»åŠ  CI/CD æ­¥éª¤ï¼šè‡ªåŠ¨è¿è¡Œ `npm run generate:openapi`
   - æ£€æµ‹æ–‡æ¡£æ˜¯å¦è¿‡æœŸï¼ˆgit diffï¼‰

2. **æ·»åŠ  API æµ‹è¯•**
   - ä½¿ç”¨ Swagger UI çš„ "Try it out" åŠŸèƒ½
   - ç¼–å†™è‡ªåŠ¨åŒ– API æµ‹è¯•è„šæœ¬

---

## ğŸ“ é™„å½•

### éªŒè¯æ–¹æ³•

```bash
# 1. è¯»å–æ‰€æœ‰ route.ts æ–‡ä»¶
find app/api -name "route.ts"

# 2. å¯¹æ¯” scripts/generate-openapi.ts ä¸­çš„æ³¨å†Œ
grep -n "path:" scripts/generate-openapi.ts

# 3. æ£€æŸ¥æ¯ä¸ª API çš„å®ç°
# - è¯·æ±‚å‚æ•°éªŒè¯ (Zod Schema)
# - å“åº”æ ¼å¼ (Success/Error)
# - HTTP çŠ¶æ€ç 
# - è®¤è¯è¦æ±‚
```

### ç›¸å…³æ–‡ä»¶

- âœ… `docs/openapi.yaml` - ç”Ÿæˆçš„æ–‡æ¡£
- âœ… `scripts/generate-openapi.ts` - æ–‡æ¡£ç”Ÿæˆè„šæœ¬
- âœ… `app/api-docs/page.tsx` - Swagger UI é¡µé¢
- âœ… `lib/validators/*.ts` - Zod éªŒè¯ schemas
- âœ… `app/api/**/route.ts` - å®é™… API å®ç°

---

**éªŒè¯å®Œæˆæ—¶é—´**: 2025-10-28
**éªŒè¯äººå‘˜**: Claude Code
**æ–‡æ¡£ç‰ˆæœ¬**: v0.1.0
