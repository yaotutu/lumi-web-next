# æç¤ºè¯ä¼˜åŒ–åŠŸèƒ½æ–‡æ¡£

## åŠŸèƒ½æ¦‚è¿°

æç¤ºè¯ä¼˜åŒ–åŠŸèƒ½ä½¿ç”¨é˜¿é‡Œäº‘é€šä¹‰åƒé—®å¤§æ¨¡å‹,è‡ªåŠ¨å°†ç”¨æˆ·è¾“å…¥çš„æç¤ºè¯ä¼˜åŒ–ä¸ºé€‚åˆ3Dæ‰“å°çš„å›¾ç‰‡ç”Ÿæˆæç¤ºè¯ã€‚

**æ ¸å¿ƒä¼˜åŠ¿:**
- âœ… å‰ç«¯å®Œå…¨é€æ˜,æ— éœ€ä¿®æ”¹å‰ç«¯ä»£ç 
- âœ… åŠŸèƒ½é»˜è®¤å¼€å¯,æ— éœ€é…ç½®å¼€å…³
- âœ… è‡ªåŠ¨é™çº§ç­–ç•¥,ä¼˜åŒ–å¤±è´¥ä¸å½±å“ä¸šåŠ¡
- âœ… å®Œæ•´çš„æ—¥å¿—è¿½è¸ª,ä¾¿äºè°ƒè¯•

## å·¥ä½œæµç¨‹

```
ç”¨æˆ·è¾“å…¥æç¤ºè¯ (å¦‚: "ä¸€åªå¯çˆ±çš„å°çŒ«")
    â†“
åç«¯æ¥æ”¶ä»»åŠ¡ (task-queue.ts)
    â†“
[æ–°å¢] è°ƒç”¨é€šä¹‰åƒé—®ä¼˜åŒ–æç¤ºè¯
    â†“
ä¼˜åŒ–åçš„æç¤ºè¯ (å¦‚: "cute cat figurine, solid structure, stable pose...")
    â†“
è°ƒç”¨é˜¿é‡Œäº‘å›¾ç‰‡ç”ŸæˆAPI
    â†“
è¿”å›é€‚åˆ3Dæ‰“å°çš„å›¾ç‰‡
```

## é…ç½®æ­¥éª¤

### 1. ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `.env.local` æ–‡ä»¶ä¸­æ·»åŠ :

```bash
# é˜¿é‡Œäº‘é€šä¹‰åƒé—® (OpenAIå…¼å®¹æ¨¡å¼) - åŠŸèƒ½é»˜è®¤å¼€å¯
QWEN_API_KEY=sk-your-api-key-here
QWEN_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
QWEN_MODEL=qwen-max
```

### 2. è·å–é˜¿é‡Œäº‘APIå¯†é’¥

1. ç™»å½• [é˜¿é‡Œäº‘ç™¾ç‚¼æ§åˆ¶å°](https://bailian.console.aliyun.com/)
2. è¿›å…¥ API-KEY ç®¡ç†é¡µé¢
3. åˆ›å»ºæ–°çš„ API Key (æ ¼å¼: `sk-xxx`)
4. å¤åˆ¶ API Key åˆ° `QWEN_API_KEY` ç¯å¢ƒå˜é‡

## ä¼˜åŒ–è§„åˆ™

æç¤ºè¯ä¼˜åŒ–éµå¾ªä»¥ä¸‹3Dæ‰“å°é€‚é…è§„åˆ™:

### âœ… æ·»åŠ çš„çº¦æŸ

1. **æ¸…æ™°çš„è½®å»“** - ç‰©ä½“è¾¹ç¼˜æ¸…æ™°å¯è¾¨,é¿å…æ¨¡ç³Š
2. **é¿å…é•‚ç©º** - ä¸ä½¿ç”¨å¤æ‚é•‚ç©ºã€ç½‘æ ¼ç»“æ„
3. **é¿å…ç»†å°é›¶ä»¶** - ä¸ç”Ÿæˆè¿‡ç»†çš„çªèµ·(æœ€å°åšåº¦>2mm)
4. **ç»“æ„ç¨³å®š** - å¼ºè°ƒå¯¹ç§°æ€§ã€åº•éƒ¨æ”¯æ’‘
5. **é¿å…æ‚¬ç©º** - ä¸ç”Ÿæˆå¤§é¢ç§¯æ‚¬ç©ºéƒ¨åˆ†
6. **çº¯è‰²èƒŒæ™¯** - ä½¿ç”¨çº¯ç™½æˆ–çº¯è‰²èƒŒæ™¯çªå‡ºä¸»ä½“
7. **æœ€ä½³è§’åº¦** - 3/4è§†è§’æˆ–æ­£è§†å›¾
8. **æè´¨é€‚é…** - å¼ºè°ƒå“‘å…‰ã€å®ä½“æ„Ÿ

### ç¤ºä¾‹å¯¹æ¯”

| ç”¨æˆ·è¾“å…¥ | ä¼˜åŒ–åçš„æç¤ºè¯ |
|---------|---------------|
| "ä¸€åªå¯çˆ±çš„å°çŒ«" | "cute cat figurine, solid structure, smooth surface, stable sitting pose, clear edges, symmetrical design, matte finish, plain white background, 3/4 view, no thin parts, suitable for 3D printing" |
| "é•‚ç©ºçš„èŠ±ç“¶" | "simple vase, solid walls, smooth curves, wide base for stability, no hollow patterns, thick structure, clean edges, matte surface, plain background, front view, 3D printable design" |
| "å¸¦ç¿…è†€çš„å¤©ä½¿é›•å¡‘" | "angel statue, compact wing design, thick feathers, solid body structure, stable base, clear facial features, symmetrical wings, no thin extensions, smooth surface, white background, 3/4 view, 3D print optimized" |

## æŠ€æœ¯æ¶æ„

### æ–‡ä»¶ç»“æ„

```
lib/
â”œâ”€â”€ providers/
â”‚   â””â”€â”€ qwen-openai.ts           # OpenAIå®¢æˆ·ç«¯å°è£…
â”œâ”€â”€ services/
â”‚   â””â”€â”€ prompt-optimizer.ts      # ä¼˜åŒ–ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ constants.ts                 # System Promptå¸¸é‡
â””â”€â”€ task-queue.ts                # é›†æˆç‚¹(ç¬¬104è¡Œ)
```

### å…³é”®ä»£ç 

**lib/task-queue.ts:104** - ä¼˜åŒ–è°ƒç”¨ç‚¹
```typescript
// ğŸ¤– ä¼˜åŒ–æç¤ºè¯(3Dæ‰“å°é€‚é…)
const optimizedPrompt = await optimizePromptFor3DPrint(prompt);

// ä½¿ç”¨ä¼˜åŒ–åçš„æç¤ºè¯ç”Ÿæˆå›¾ç‰‡
for await (const imageUrl of generateImageStream(optimizedPrompt, remainingCount)) {
  // ...
}
```

**lib/services/prompt-optimizer.ts** - é™çº§ç­–ç•¥
```typescript
export async function optimizePromptFor3DPrint(userInput: string): Promise<string> {
  try {
    // é»˜è®¤å¼€å¯,ç›´æ¥è°ƒç”¨ä¼˜åŒ–
    const optimized = await optimizePromptWithQwen(userInput, SYSTEM_PROMPT);
    return optimized;
  } catch (error) {
    // é™çº§:å¤±è´¥æ—¶ä½¿ç”¨åŸå§‹è¾“å…¥
    log.warn("ä¼˜åŒ–å¤±è´¥,é™çº§ä½¿ç”¨åŸå§‹è¾“å…¥", error);
    return userInput;
  }
}
```

## æ—¥å¿—è¿½è¸ª

å¯ç”¨å,æ—¥å¿—ä¸­ä¼šåŒ…å«ä»¥ä¸‹ä¿¡æ¯:

```json
{
  "level": "info",
  "component": "PromptOptimizer",
  "msg": "å¼€å§‹ä¼˜åŒ–æç¤ºè¯",
  "userInput": "ä¸€åªå¯çˆ±çš„å°çŒ«",
  "inputLength": 7
}

{
  "level": "info",
  "component": "PromptOptimizer",
  "msg": "æç¤ºè¯ä¼˜åŒ–æˆåŠŸ",
  "original": "ä¸€åªå¯çˆ±çš„å°çŒ«",
  "optimized": "cute cat figurine, solid structure...",
  "originalLength": 7,
  "optimizedLength": 85
}
```

**å¤±è´¥æ—¶çš„é™çº§æ—¥å¿—**:
```json
{
  "level": "warn",
  "component": "PromptOptimizer",
  "msg": "æç¤ºè¯ä¼˜åŒ–å¤±è´¥,é™çº§ä½¿ç”¨åŸå§‹è¾“å…¥",
  "error": "APIè°ƒç”¨å¤±è´¥: 429 Too Many Requests",
  "userInput": "ä¸€åªå¯çˆ±çš„å°çŒ«"
}
```

## æ•…éšœå¤„ç†

### åœºæ™¯1: ä¼˜åŒ–å¤±è´¥

**è¡¨ç°**: æ—¥å¿—ä¸­å‡ºç°é™çº§è­¦å‘Š
**å½±å“**: æ— å½±å“,è‡ªåŠ¨ä½¿ç”¨åŸå§‹æç¤ºè¯
**å¤„ç†**: æ£€æŸ¥API Keyé…ç½®å’Œç½‘ç»œè¿æ¥

### åœºæ™¯2: APIé™æµ(429)

**è¡¨ç°**: æ—¥å¿—æ˜¾ç¤º "429 Too Many Requests"
**å½±å“**: è‡ªåŠ¨é™çº§,ä½¿ç”¨åŸå§‹æç¤ºè¯
**å¤„ç†**: ç­‰å¾…é™æµè§£é™¤,æˆ–å‡çº§APIå¥—é¤

### åœºæ™¯3: API Keyæ— æ•ˆ

**è¡¨ç°**: æ—¥å¿—æ˜¾ç¤º "401 Unauthorized"
**å½±å“**: è‡ªåŠ¨é™çº§,ä½¿ç”¨åŸå§‹æç¤ºè¯
**å¤„ç†**: æ£€æŸ¥ `QWEN_API_KEY` æ˜¯å¦æ­£ç¡®


## æ€§èƒ½å½±å“

- **é¢å¤–å»¶è¿Ÿ**: çº¦ 1-3 ç§’(é€šä¹‰åƒé—®APIè°ƒç”¨)
- **å¹¶å‘å½±å“**: ä¸å½±å“å›¾ç‰‡ç”Ÿæˆçš„å¹¶å‘æ§åˆ¶
- **å¤±è´¥å½±å“**: 0 ç§’(é™çº§ç­–ç•¥ç«‹å³è¿”å›åŸå§‹è¾“å…¥)

## æˆæœ¬ä¼°ç®—

ä»¥é˜¿é‡Œäº‘é€šä¹‰åƒé—® `qwen-max` ä¸ºä¾‹:

- **è¾“å…¥Token**: çº¦ 100 tokens (System Prompt + ç”¨æˆ·è¾“å…¥)
- **è¾“å‡ºToken**: çº¦ 100 tokens (ä¼˜åŒ–åçš„æç¤ºè¯)
- **å•æ¬¡æˆæœ¬**: çº¦ Â¥0.02 å…ƒ
- **æœˆåº¦æˆæœ¬**: 1000æ¬¡ä¼˜åŒ– â‰ˆ Â¥20 å…ƒ

> ğŸ’¡ æç¤º: å¯ä½¿ç”¨ `qwen-plus` æˆ– `qwen-turbo` é™ä½æˆæœ¬

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•éªŒè¯åŠŸèƒ½æ˜¯å¦ç”Ÿæ•ˆ?

æŸ¥çœ‹æ—¥å¿—,æœç´¢ "PromptOptimizer" å…³é”®è¯,åº”è¯¥èƒ½çœ‹åˆ°ä¼˜åŒ–å‰åçš„æç¤ºè¯å¯¹æ¯”ã€‚

### Q2: ä¼˜åŒ–å¤±è´¥ä¼šå½±å“å›¾ç‰‡ç”Ÿæˆå—?

ä¸ä¼šã€‚ä¼˜åŒ–å¤±è´¥ä¼šè‡ªåŠ¨é™çº§ä½¿ç”¨åŸå§‹è¾“å…¥,ä¸å½±å“ä¸šåŠ¡æµç¨‹ã€‚

### Q3: å¦‚ä½•è°ƒæ•´ä¼˜åŒ–è§„åˆ™?

ä¿®æ”¹ `lib/constants.ts` ä¸­çš„ `PROMPT_OPTIMIZATION_SYSTEM_PROMPT` å¸¸é‡ã€‚

### Q4: æ”¯æŒå“ªäº›æ¨¡å‹?

æ”¯æŒé˜¿é‡Œäº‘é€šä¹‰åƒé—®å…¨ç³»åˆ—:
- `qwen-max` - æœ€å¼ºæ•ˆæœ,ä»·æ ¼è¾ƒé«˜
- `qwen-plus` - æ€§ä»·æ¯”é«˜
- `qwen-turbo` - é€Ÿåº¦å¿«,æˆæœ¬ä½

é€šè¿‡ `QWEN_MODEL` ç¯å¢ƒå˜é‡é…ç½®ã€‚

### Q5: å¯ä»¥ä½¿ç”¨å…¶ä»–å¤§æ¨¡å‹å—?

å¯ä»¥ã€‚åªéœ€ä¿®æ”¹ `lib/providers/qwen-openai.ts`,æ›¿æ¢ä¸ºå…¶ä»– OpenAI å…¼å®¹çš„æœåŠ¡(å¦‚OpenAI GPTã€æ™ºè°±AIç­‰)ã€‚

## æµ‹è¯•å»ºè®®

1. **æ­£å¸¸æµ‹è¯•** - é…ç½®æ­£ç¡®çš„ API Key,æäº¤ä»»åŠ¡,æŸ¥çœ‹ä¼˜åŒ–æ•ˆæœ
2. **æŸ¥çœ‹æ—¥å¿—å¯¹æ¯”** - å¯¹æ¯”ä¼˜åŒ–å‰åçš„æç¤ºè¯
3. **æ¨¡æ‹Ÿå¤±è´¥æµ‹è¯•** - è®¾ç½®é”™è¯¯çš„ API Key,éªŒè¯é™çº§é€»è¾‘æ˜¯å¦æ­£å¸¸å·¥ä½œ

## ç»´æŠ¤å»ºè®®

1. **å®šæœŸæŸ¥çœ‹æ—¥å¿—** - ç›‘æ§ä¼˜åŒ–æˆåŠŸç‡å’Œå¤±è´¥åŸå› 
2. **è°ƒæ•´System Prompt** - æ ¹æ®å®é™…æ•ˆæœä¼˜åŒ–æç¤ºè¯è§„åˆ™
3. **ç›‘æ§æˆæœ¬** - è·Ÿè¸ªAPIè°ƒç”¨é‡å’Œè´¹ç”¨
4. **A/Bæµ‹è¯•** - å¯¹æ¯”ä¼˜åŒ–å‰åçš„3Dæ¨¡å‹è´¨é‡
