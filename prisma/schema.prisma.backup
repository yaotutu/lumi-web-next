// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// 用户层
// ============================================

// 用户表
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  requests  GenerationRequest[]  // 用户的生成请求
  assets    UserAsset[]          // 用户的模型资产
}

// ============================================
// 业务层：用户视角的生成请求
// ============================================

// GenerationRequest - 用户的生成请求（顶层聚合根）
model GenerationRequest {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 请求输入
  prompt    String

  // 请求整体状态（业务语义）
  status    RequestStatus @default(IMAGE_GENERATION_PENDING)

  // 当前所处阶段
  phase     RequestPhase @default(IMAGE_GENERATION)

  // 时间戳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  completedAt DateTime?
  failedAt  DateTime?
  errorMessage String?

  // 关联
  imageGenerationJob  ImageGenerationJob?  // 一对一：图片生成任务
  images              GeneratedImage[]      // 一对多：生成的图片
  generatedModels     GeneratedModel[]     // 一对多：AI生成的模型（通过 generatedModel.generationJob 可访问 ModelGenerationJob）

  @@index([userId, createdAt(sort: Desc)])
  @@index([status])
  @@index([phase])
}

// GeneratedImage - AI生成的图片（属于Request）
model GeneratedImage {
  id         String  @id @default(cuid())
  requestId  String
  request    GenerationRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  url        String
  index      Int     // 0-3
  prompt     String? // 实际使用的提示词（经过LLM优化）

  // Provider相关
  providerTaskId    String?
  providerRequestId String?

  createdAt  DateTime @default(now())

  // 关联：该图片生成的模型（一对一）
  generatedModel GeneratedModel? @relation("ImageToModel")

  @@unique([requestId, index])
  @@index([requestId])
}

// GeneratedModel - AI生成的3D模型（属于Request）
model GeneratedModel {
  id        String  @id @default(cuid())
  requestId String
  request   GenerationRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  sourceImageId String  @unique
  sourceImage   GeneratedImage @relation("ImageToModel", fields: [sourceImageId], references: [id], onDelete: Cascade)

  // 基本信息
  name      String
  modelUrl  String?
  previewImageUrl String?
  format    String @default("OBJ")
  fileSize  Int?

  // 时间戳
  createdAt   DateTime @default(now())
  completedAt DateTime?
  failedAt    DateTime?
  errorMessage String?

  // 关联：生成任务
  generationJob ModelGenerationJob?

  // 关联：用户资产
  userAsset UserAsset?

  @@index([requestId, createdAt])
}

// ============================================
// 执行层：队列中的任务单元
// ============================================

// ImageGenerationJob - 图片生成任务（Queue单元）
model ImageGenerationJob {
  id         String  @id @default(cuid())
  requestId  String  @unique  // 一对一关系
  request    GenerationRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  // 执行状态
  status     JobStatus @default(PENDING)
  priority   Int       @default(0)     // 优先级（数字越大优先级越高）
  progress   Int       @default(0)     // 0-100

  // 重试控制
  retryCount    Int @default(0)         // 已重试次数
  maxRetries    Int @default(3)         // 最大重试次数
  nextRetryAt   DateTime?               // 下次重试时间

  // 超时控制
  timeoutAt     DateTime?               // 超时时间点

  // Provider相关
  providerName      String?             // 使用的供应商（aliyun/siliconflow）
  providerJobId     String?
  providerRequestId String?

  // 时间戳
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  startedAt   DateTime?
  completedAt DateTime?
  failedAt    DateTime?
  cancelledAt DateTime?
  timeoutedAt DateTime?  // 超时时间

  // 错误信息
  errorMessage String?
  errorCode    String?   // 错误码（用于判断是否可重试）
  errorStack   String?   // 错误堆栈（调试用）

  // 执行信息
  executionDuration Int?  // 执行时长（毫秒）
  workerNodeId String?    // 执行的Worker节点ID（多实例部署时有用）

  @@index([status, priority(sort: Desc), createdAt])  // Worker查询优化：状态+优先级+时间
  @@index([status, nextRetryAt])                       // 重试任务查询
  @@index([status, timeoutAt])                         // 超时检测查询
}

// ModelGenerationJob - 模型生成任务（Queue单元）
model ModelGenerationJob {
  id        String  @id @default(cuid())
  modelId   String  @unique  // 一对一关系
  model     GeneratedModel @relation(fields: [modelId], references: [id], onDelete: Cascade)

  // 执行状态
  status     JobStatus @default(PENDING)
  priority   Int       @default(0)
  progress   Int       @default(0)

  // 重试控制
  retryCount    Int @default(0)
  maxRetries    Int @default(3)
  nextRetryAt   DateTime?
  timeoutAt     DateTime?

  // Provider相关
  providerName      String?
  providerJobId     String?
  providerRequestId String?

  // 时间戳
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  startedAt   DateTime?
  completedAt DateTime?
  failedAt    DateTime?
  cancelledAt DateTime?
  timeoutedAt DateTime?

  // 错误信息
  errorMessage String?
  errorCode    String?
  errorStack   String?

  // 执行信息
  executionDuration Int?
  workerNodeId String?

  @@index([status, priority(sort: Desc), createdAt])
  @@index([status, nextRetryAt])
  @@index([status, timeoutAt])
}

// ============================================
// 配置层：动态队列配置
// ============================================

// QueueConfig - 队列配置（运行时可调整）
model QueueConfig {
  id        String   @id @default(cuid())
  queueName String   @unique  // "image_generation" | "model_generation"

  // 并发控制
  maxConcurrency Int @default(1)  // 最大并发数

  // 超时控制
  jobTimeout Int @default(300000)  // 单个Job超时时间（毫秒），默认5分钟

  // 重试策略
  maxRetries     Int @default(3)   // 最大重试次数
  retryDelayBase Int @default(5000) // 重试基础延迟（毫秒）
  retryDelayMax  Int @default(60000) // 重试最大延迟（毫秒）

  // 优先级
  enablePriority Boolean @default(false)  // 是否启用优先级

  // 队列状态
  isActive Boolean @default(true)  // 队列是否激活

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  updatedBy String?  // 谁修改的配置

  @@index([queueName])
}

// ============================================
// 资源层：用户管理的资产
// ============================================

// UserAsset - 用户的3D模型资产（统一管理AI生成和用户上传）
model UserAsset {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 来源
  source    AssetSource

  // AI生成时关联GeneratedModel
  generatedModelId String? @unique
  generatedModel   GeneratedModel? @relation(fields: [generatedModelId], references: [id])

  // 基本信息
  name        String
  description String?
  modelUrl    String
  previewImageUrl String?
  format      String
  fileSize    Int?

  // 模型元数据
  faceCount   Int?
  vertexCount Int?
  quality     String?

  // 模型广场
  visibility    AssetVisibility @default(PRIVATE)
  publishedAt   DateTime?

  // 统计
  viewCount     Int @default(0)
  likeCount     Int @default(0)
  downloadCount Int @default(0)

  // 打印服务
  sliceTaskId String?

  // 时间戳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt(sort: Desc)])
  @@index([visibility, publishedAt(sort: Desc)])
  @@index([visibility, likeCount(sort: Desc)])
  @@index([source])
}

// ============================================
// 枚举类型
// ============================================

// 请求状态（完整的业务状态）
enum RequestStatus {
  // 图片生成阶段
  IMAGE_GENERATION_PENDING    // 等待生成图片
  IMAGE_GENERATION_RUNNING    // 图片生成中
  IMAGE_GENERATION_COMPLETED  // 图片已完成，等待用户操作
  IMAGE_GENERATION_FAILED     // 图片生成失败

  // 模型生成阶段
  MODEL_GENERATION_PENDING    // 等待生成模型（至少有一个Job在PENDING）
  MODEL_GENERATION_RUNNING    // 模型生成中（至少有一个Job在RUNNING）
  MODEL_GENERATION_PARTIAL    // 部分模型已完成
  MODEL_GENERATION_COMPLETED  // 所有模型已完成
  MODEL_GENERATION_FAILED     // 模型生成失败

  // 终态
  COMPLETED    // 请求完成（至少生成了一个模型）
  CANCELLED    // 用户取消
}

// 请求所处阶段
enum RequestPhase {
  IMAGE_GENERATION   // 图片生成阶段
  MODEL_GENERATION   // 模型生成阶段
  COMPLETED          // 已完成
}

// Job状态
enum JobStatus {
  PENDING    // 等待执行
  RUNNING    // 执行中
  RETRYING   // 重试中（失败后等待重试）
  COMPLETED  // 已完成
  FAILED     // 失败（超过最大重试次数）
  CANCELLED  // 取消
  TIMEOUT    // 超时
}

// 资产来源
enum AssetSource {
  AI_GENERATED   // AI生成（关联GeneratedModel）
  USER_UPLOADED  // 用户上传
  IMPORTED       // 导入
}

// 资产可见性
enum AssetVisibility {
  PRIVATE
  PUBLIC
}
