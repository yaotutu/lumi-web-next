// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 用户表
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tasks     Task[]
}

// 任务表 - 核心业务实体
model Task {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 任务输入
  prompt      String

  // 任务状态
  status      TaskStatus @default(IMAGE_PENDING)

  // 文生图阶段数据
  imageGenerationStartedAt  DateTime?
  imageGenerationCompletedAt DateTime?
  selectedImageIndex        Int?

  // 图生3D阶段数据
  modelGenerationStartedAt  DateTime?
  modelGenerationCompletedAt DateTime?

  // 任务级别时间戳
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  completedAt DateTime?
  failedAt    DateTime?
  errorMessage String?

  // 关联的生成结果
  images      TaskImage[]
  model       TaskModel?

  @@index([userId, createdAt(sort: Desc)])
  @@index([status])
}

// 任务图片表
model TaskImage {
  id        String   @id @default(cuid())
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // 图片数据
  // ⚠️ 当前存储：阿里云临时URL（24小时有效期）
  // 格式示例: https://dashscope-result.oss-cn-beijing.aliyuncs.com/xxx.png
  // TODO: 对接OSS后改为本地路径: /generated/images/{taskId}/0.png
  url       String
  index     Int      // 0-3

  // 生成该图片使用的提示词（可选，用于调试和追踪）
  prompt    String?

  // 阿里云API数据(可选)
  aliyunTaskId    String?
  aliyunRequestId String?

  createdAt DateTime @default(now())

  @@unique([taskId, index])
  @@index([taskId])
}

// 3D模型表
model TaskModel {
  id        String   @id @default(cuid())
  taskId    String   @unique
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // 模型基本信息
  name      String
  modelUrl  String?  // 本地路径: /generated/models/{taskId}.obj (或 .glb)
  previewImageUrl String?  // 模型预览图 URL (从腾讯云返回的预览图)

  // 生成状态
  status    ModelStatus @default(PENDING)
  progress  Int      @default(0)

  // 模型元数据
  format    String   @default("OBJ")
  fileSize  Int?
  faceCount Int?
  vertexCount Int?
  quality   String   @default("高清")

  // 3D生成API相关
  apiTaskId String?
  apiRequestId String?

  // 打印服务相关
  sliceTaskId String?  // 打印服务返回的切片任务ID，用于查询打印状态

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  completedAt DateTime?
  failedAt  DateTime?
  errorMessage String?

  @@index([status])
}

// 枚举: 任务状态
enum TaskStatus {
  // === 图片生成阶段 ===
  IMAGE_PENDING      // 图片生成：等待开始（队列中）
  IMAGE_GENERATING   // 图片生成：生成中
  IMAGE_COMPLETED    // 图片生成：已完成，等待用户选择

  // === 3D模型生成阶段 ===
  MODEL_PENDING      // 模型生成：等待开始（用户已选图片）
  MODEL_GENERATING   // 模型生成：生成中
  MODEL_COMPLETED    // 模型生成：已完成

  // === 终态 ===
  FAILED             // 任务失败
  CANCELLED          // 用户取消
}

// 枚举: 3D模型状态（与 Provider 的 WAIT/RUN/DONE/FAIL 一一对应）
enum ModelStatus {
  PENDING      // 等待处理（对应 Provider 的 WAIT）
  GENERATING   // 生成中（对应 Provider 的 RUN）
  COMPLETED    // 生成完成（对应 Provider 的 DONE）
  FAILED       // 生成失败（对应 Provider 的 FAIL）
}
