// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// 用户层（2 个表）
// ============================================

// 用户表
model User {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String?
  avatar      String?

  lastLoginAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  requests           GenerationRequest[]
  models             Model[]
  emailVerifications EmailVerificationCode[]
  interactions       ModelInteraction[]
}

// 邮箱验证码表
model EmailVerificationCode {
  id         String    @id @default(cuid())
  email      String
  code       String
  expiresAt  DateTime
  verifiedAt DateTime?
  createdAt  DateTime  @default(now())

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email, createdAt(sort: Desc)])
  @@index([email, expiresAt])
}

// ============================================
// 任务层（2 个表）
// ============================================

// GenerationRequest - 生成请求（包含状态）
model GenerationRequest {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  prompt String

  // 状态管理
  status RequestStatus @default(IMAGE_PENDING)
  phase  RequestPhase  @default(IMAGE_GENERATION)
  selectedImageIndex Int?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  images GeneratedImage[]
  model  Model?

  @@index([userId, createdAt(sort: Desc)])
  @@index([status, phase])
}

// GeneratedImage - 生成的图片
model GeneratedImage {
  id        String @id @default(cuid())
  requestId String
  request   GenerationRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  index       Int
  imageUrl    String?
  imagePrompt String?

  imageStatus  ImageStatus @default(PENDING)

  createdAt    DateTime  @default(now())
  completedAt  DateTime?
  failedAt     DateTime?
  errorMessage String?

  generationJob ImageGenerationJob?
  model         Model?

  @@unique([requestId, index])
  @@index([requestId])
  @@index([imageStatus])
}

// ============================================
// 模型层（1 个表）
// ============================================

// Model - 统一模型表（AI生成 + 用户上传）
model Model {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 来源标识
  source ModelSource @default(AI_GENERATED)

  // AI生成时的关联（1:1约束）
  requestId     String?         @unique
  request       GenerationRequest? @relation(fields: [requestId], references: [id], onDelete: SetNull)

  sourceImageId String?         @unique
  sourceImage   GeneratedImage? @relation(fields: [sourceImageId], references: [id], onDelete: SetNull)

  // 基本信息
  name            String
  description     String?
  modelUrl        String?
  previewImageUrl String?
  format          String  @default("OBJ")
  fileSize        Int?

  // 可见性
  visibility  ModelVisibility @default(PRIVATE)
  publishedAt DateTime?

  // 统计数据
  viewCount     Int @default(0)
  likeCount     Int @default(0)
  favoriteCount Int @default(0)
  downloadCount Int @default(0)

  // 打印相关
  sliceTaskId String?

  // 时间戳
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  completedAt  DateTime?
  failedAt     DateTime?
  errorMessage String?

  // 关联
  generationJob ModelGenerationJob?
  interactions  ModelInteraction[]

  @@index([userId, createdAt(sort: Desc)])
  @@index([source])
  @@index([visibility, publishedAt(sort: Desc)])
  @@index([visibility, likeCount(sort: Desc)])
}

// ============================================
// 执行层（2 个表）
// ============================================

// ImageGenerationJob - 图片生成任务
model ImageGenerationJob {
  id      String         @id @default(cuid())
  imageId String         @unique
  image   GeneratedImage @relation(fields: [imageId], references: [id], onDelete: Cascade)

  status      JobStatus @default(PENDING)
  priority    Int       @default(0)
  retryCount  Int       @default(0)
  maxRetries  Int       @default(3)
  nextRetryAt DateTime?
  timeoutAt   DateTime?

  providerName  String?
  providerJobId String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime?
  completedAt DateTime?
  failedAt    DateTime?

  errorMessage String?
  errorCode    String?
  executionDuration Int?

  @@index([status, priority(sort: Desc), createdAt])
  @@index([status, nextRetryAt])
}

// ModelGenerationJob - 模型生成任务
model ModelGenerationJob {
  id      String @id @default(cuid())
  modelId String @unique
  model   Model  @relation(fields: [modelId], references: [id], onDelete: Cascade)

  status      JobStatus @default(PENDING)
  priority    Int       @default(0)
  progress    Int       @default(0)
  retryCount  Int       @default(0)
  maxRetries  Int       @default(3)
  nextRetryAt DateTime?
  timeoutAt   DateTime?

  providerName  String?
  providerJobId String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime?
  completedAt DateTime?
  failedAt    DateTime?

  errorMessage String?
  errorCode    String?
  executionDuration Int?

  @@index([status, priority(sort: Desc), createdAt])
  @@index([status, nextRetryAt])
}

// ============================================
// 配置层（1 个表）
// ============================================

// QueueConfig - 队列配置
model QueueConfig {
  id             String  @id @default(cuid())
  queueName      String  @unique
  maxConcurrency Int     @default(1)
  jobTimeout     Int     @default(300000)
  maxRetries     Int     @default(3)
  retryDelayBase Int     @default(5000)
  retryDelayMax  Int     @default(60000)
  enablePriority Boolean @default(false)
  isActive       Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// 交互层（1 个表）
// ============================================

// ModelInteraction - 点赞/收藏记录
model ModelInteraction {
  id        String          @id @default(cuid())
  userId    String
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  modelId   String
  model     Model           @relation(fields: [modelId], references: [id], onDelete: Cascade)

  type      InteractionType

  createdAt DateTime @default(now())

  @@unique([userId, modelId, type])
  @@index([userId, type, createdAt(sort: Desc)])
  @@index([modelId, type])
}

// ============================================
// 枚举
// ============================================

// 请求状态
enum RequestStatus {
  IMAGE_PENDING
  IMAGE_GENERATING
  IMAGE_COMPLETED
  IMAGE_FAILED
  MODEL_PENDING
  MODEL_GENERATING
  MODEL_COMPLETED
  MODEL_FAILED
  COMPLETED
  FAILED
  CANCELLED
}

// 请求阶段
enum RequestPhase {
  IMAGE_GENERATION
  AWAITING_SELECTION
  MODEL_GENERATION
  COMPLETED
}

// 图片状态
enum ImageStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}

// Job状态
enum JobStatus {
  PENDING
  RUNNING
  RETRYING
  COMPLETED
  FAILED
  CANCELLED
  TIMEOUT
}

// 模型来源
enum ModelSource {
  AI_GENERATED
  USER_UPLOADED
}

// 模型可见性
enum ModelVisibility {
  PRIVATE
  PUBLIC
}

// 交互类型
enum InteractionType {
  LIKE
  FAVORITE
}
