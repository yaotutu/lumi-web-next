// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 用户表
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tasks     Task[]
  models    Model[]   // 用户拥有的所有模型（AI生成 + 用户上传）
}

// 任务表 - 核心业务实体
model Task {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 任务输入
  prompt      String

  // 任务状态
  status      TaskStatus @default(IMAGE_PENDING)

  // 文生图阶段数据
  imageGenerationStartedAt  DateTime?
  imageGenerationCompletedAt DateTime?
  selectedImageIndex        Int?

  // 图生3D阶段数据
  modelGenerationStartedAt  DateTime?
  modelGenerationCompletedAt DateTime?

  // 任务级别时间戳
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  completedAt DateTime?
  failedAt    DateTime?
  errorMessage String?

  // 关联的生成结果
  images      TaskImage[]
  models      Model[]   // AI生成的模型（可能有多个历史版本）

  @@index([userId, createdAt(sort: Desc)])
  @@index([status])
}

// 任务图片表
model TaskImage {
  id        String   @id @default(cuid())
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // 图片数据
  // ⚠️ 当前存储：阿里云临时URL（24小时有效期）
  // 格式示例: https://dashscope-result.oss-cn-beijing.aliyuncs.com/xxx.png
  // TODO: 对接OSS后改为本地路径: /generated/images/{taskId}/0.png
  url       String
  index     Int      // 0-3

  // 生成该图片使用的提示词（可选，用于调试和追踪）
  prompt    String?

  // 阿里云API数据(可选)
  aliyunTaskId    String?
  aliyunRequestId String?

  createdAt DateTime @default(now())

  @@unique([taskId, index])
  @@index([taskId])
}

// 3D模型表 - 独立实体（核心资源）
model Model {
  id        String   @id @default(cuid())

  // 归属关系（必需）
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 来源关系（可选）
  source    ModelSource @default(AI_GENERATED)  // 模型来源：AI生成/用户上传
  taskId    String?                              // AI生成时有值，上传时为null
  task      Task?    @relation(fields: [taskId], references: [id], onDelete: SetNull)

  // 模型基本信息
  name      String
  description String?              // 模型描述（用户可编辑）
  modelUrl  String                 // 模型文件 URL
  previewImageUrl String?          // 预览图 URL

  // AI生成相关（仅AI生成时有值）
  prompt    String?                // 原始提示词（AI生成时记录）

  // 模型元数据
  format    String   @default("OBJ")
  fileSize  Int?
  faceCount Int?
  vertexCount Int?
  quality   String?

  // 生成状态（仅AI生成时使用）
  generationStatus  ModelGenerationStatus?  // AI生成的状态
  progress          Int @default(0)

  // 3D生成API相关（AI生成）
  apiTaskId     String?
  apiRequestId  String?

  // 打印服务相关
  sliceTaskId String?  // 打印服务返回的切片任务ID，用于查询打印状态

  // 隐私和共享设置（模型广场功能）
  visibility    ModelVisibility @default(PRIVATE)  // 可见性：公开/私有
  publishedAt   DateTime?                          // 发布时间（首次设为公开时记录）

  // 统计数据
  viewCount     Int @default(0)   // 浏览次数
  likeCount     Int @default(0)   // 点赞数（预留）
  downloadCount Int @default(0)   // 下载次数（预留）

  // 时间戳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  completedAt DateTime?
  failedAt  DateTime?
  errorMessage String?

  // 索引优化
  @@index([userId, createdAt(sort: Desc)])               // 我的模型列表
  @@index([visibility, publishedAt(sort: Desc)])         // 公开模型列表（按时间）
  @@index([visibility, likeCount(sort: Desc)])           // 公开模型列表（按热度）
  @@index([source])                                      // 按来源筛选
  @@index([generationStatus])                            // Worker 查询（仅AI生成）
}

// 枚举: 任务状态
enum TaskStatus {
  // === 图片生成阶段 ===
  IMAGE_PENDING      // 图片生成：等待开始（队列中）
  IMAGE_GENERATING   // 图片生成：生成中
  IMAGE_COMPLETED    // 图片生成：已完成，等待用户选择

  // === 3D模型生成阶段 ===
  MODEL_PENDING      // 模型生成：等待开始（用户已选图片）
  MODEL_GENERATING   // 模型生成：生成中
  MODEL_COMPLETED    // 模型生成：已完成

  // === 终态 ===
  FAILED             // 任务失败
  CANCELLED          // 用户取消
}

// 枚举: 模型生成状态（与 Provider 的 WAIT/RUN/DONE/FAIL 一一对应）
enum ModelGenerationStatus {
  PENDING      // 等待处理（对应 Provider 的 WAIT）
  GENERATING   // 生成中（对应 Provider 的 RUN）
  COMPLETED    // 生成完成（对应 Provider 的 DONE）
  FAILED       // 生成失败（对应 Provider 的 FAIL）
}

// 枚举: 模型来源
enum ModelSource {
  AI_GENERATED   // AI 生成（通过 Task）
  USER_UPLOADED  // 用户上传
  IMPORTED       // 从其他平台导入（预留）
}

// 枚举: 模型可见性（模型广场功能）
enum ModelVisibility {
  PRIVATE   // 私有（仅创建者可见）
  PUBLIC    // 公开（所有人可见）
}
